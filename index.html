<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificador de Gastos IA</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci贸n de fuente Inter y colores base -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Estilos para las pesta帽as activas/inactivas */
        .tab-active {
            border-bottom: 2px solid #4F46E5;
            color: #4F46E5;
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #6B7280;
            font-weight: 500;
        }
        .tab-inactive:hover {
            color: #374151;
            border-bottom: 2px solid #D1D5DB;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Spinner para el bot贸n */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <!-- Librer铆a ExcelJS para generar el archivo XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl border border-gray-100 relative">
        
        <!-- Bot贸n de Ajustes (Solo Reglas) -->
        <button id="settings-btn" class="absolute top-6 right-6 text-gray-400 hover:text-indigo-600 transition-colors p-2 rounded-full hover:bg-gray-100 flex items-center gap-2" title="Configurar Reglas Globales">
            <span class="text-xs font-medium">Reglas Globales</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>

        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900 mb-2 text-center">
            Clasificador de Gastos
        </h1>
        <p class="text-center text-gray-500 mb-8">Inteligencia Artificial aplicada a los Objetos del Gasto (ODG)</p>
        
        <!-- rea de Configuraci贸n (Oculta por defecto) -->
        <div id="criteria-panel" class="hidden mb-8 space-y-5 bg-indigo-50 p-5 rounded-lg border border-indigo-100 fade-in shadow-sm">
            
            <!-- Secci贸n Reglas -->
            <div class="space-y-2">
                <div class="flex justify-between items-center">
                    <label for="user-criteria" class="block text-sm font-bold text-indigo-800 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Reglas Globales (Compartidas por todos)
                    </label>
                    <span class="text-xs text-indigo-400 font-mono bg-white px-2 py-1 rounded border border-indigo-100">Base de Datos P煤blica</span>
                </div>
                <p class="text-xs text-indigo-600 mb-2">锔 Cuidado: Cualquier cambio que hagas aqu铆 afectar谩 a todos los usuarios de la aplicaci贸n.</p>
                <textarea id="user-criteria" rows="4" class="w-full p-3 border border-indigo-200 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-sm bg-white" placeholder="Ej: 'Todos los gastos de Tienda Inglesa van al rubro 111-000'"></textarea>
            </div>

            <div class="flex justify-end pt-2">
                <button id="save-settings-button" class="bg-indigo-600 text-white text-sm font-semibold py-2 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition shadow-sm">
                    Guardar Cambios Globales
                </button>
            </div>
        </div>

        <!-- Sistema de Pesta帽as -->
        <div class="flex border-b border-gray-200 mb-6">
            <button id="tab-text" class="flex-1 py-4 text-center transition-colors duration-200 tab-active focus:outline-none">
                 Clasificar por Texto
            </button>
            <button id="tab-image" class="flex-1 py-4 text-center transition-colors duration-200 tab-inactive focus:outline-none">
                 Clasificar Factura (PDF/Img)
            </button>
        </div>

        <div class="space-y-8">

            <!-- PANEL 1: CLASIFICACIN POR TEXTO -->
            <div id="panel-text" class="space-y-4 fade-in">
                <div>
                    <label for="expense-description" class="block text-sm font-medium text-gray-700 mb-1">Descripci贸n del Gasto:</label>
                    <textarea id="expense-description" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="Ej: 'Pago de factura de UTE por $ 4.500' o 'Compra de insumos de oficina'"></textarea>
                    <p class="text-xs text-gray-400 mt-1 text-right">Tip: Si incluyes el monto en el texto, la IA intentar谩 extraerlo.</p>
                </div>
                
                <button id="classify-text-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 ease-in-out flex items-center justify-center space-x-2 h-12">
                    <span class="btn-text">Clasificar Texto</span>
                    <div class="btn-loader hidden spinner"></div>
                </button>
            </div>
            
            <!-- PANEL 2: CARGA DE DOCUMENTO (Imagen o PDF) -->
            <div id="panel-image" class="space-y-4 hidden fade-in">
                <div>
                    <label for="invoice-upload" class="block text-sm font-medium text-gray-700 mb-1">Adjuntar Factura (Imagen o PDF):</label>
                    <input type="file" id="invoice-upload" accept="image/png, image/jpeg, application/pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 border rounded-lg p-2"/>
                    
                    <!-- Vista previa -->
                    <div class="mt-4 p-4 border border-dashed border-gray-300 rounded-lg bg-gray-50 flex flex-col items-center justify-center min-h-[150px]">
                        <img id="image-preview" src="" alt="Vista previa" class="rounded-lg max-h-48 w-auto hidden shadow-sm"/>
                        <div id="pdf-preview" class="text-center hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg>
                            <p class="text-sm text-gray-800 font-medium" id="pdf-filename"></p>
                        </div>
                        <p id="placeholder-text" class="text-sm text-gray-400">Seleccione un archivo para visualizar</p>
                    </div>
                </div>
                
                <button id="classify-image-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 ease-in-out flex items-center justify-center space-x-2 disabled:opacity-50 disabled:cursor-not-allowed h-12" disabled>
                    <span class="btn-text">Analizar y Clasificar Documento</span>
                    <div class="btn-loader hidden spinner"></div>
                </button>
            </div>

            <div id="error-message" class="hidden text-red-600 font-medium text-center p-3 bg-red-50 border border-red-300 rounded-lg"></div>

            <!-- Panel de Resultados -->
            <div id="results-panel" class="hidden space-y-4 fade-in">
                <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Resultados de la Clasificaci贸n</h2>
                
                <div class="overflow-x-auto shadow ring-1 ring-black ring-opacity-5 sm:rounded-lg">
                    <table class="min-w-full divide-y divide-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Importe</th>
                                <th scope="col" class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Moneda</th>
                                <!-- Nuevas Columnas -->
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ODG</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripci贸n Rubro</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/3">Motivo/Explicaci贸n</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Los resultados se insertar谩n aqu铆 -->
                        </tbody>
                    </table>
                </div>

                <!-- Bot贸n de Descarga -->
                <button id="download-excel-button" class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200 ease-in-out flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    <span>Descargar a Excel (.xlsx)</span>
                </button>
            </div>
            
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuraci贸n de Firebase ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- API Key Fija ---
        const apiKey = ""; // <<< 隆PEGAR TU CLAVE DE GOOGLE AQU!
        
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        // --- Variables Globales ---
        let app, db, auth, userId;
        let currentSavedCriteria = "";
        let criteriaDocRef;
        let currentImageFile = null;
        let classifiedData = [];
        let RUBROS_DB = [];

        // --- Elementos del DOM ---
        const settingsBtn = document.getElementById("settings-btn");
        const criteriaPanel = document.getElementById("criteria-panel");
        const criteriaInput = document.getElementById("user-criteria");
        const saveSettingsButton = document.getElementById("save-settings-button");

        const tabText = document.getElementById("tab-text");
        const tabImage = document.getElementById("tab-image");
        const panelText = document.getElementById("panel-text");
        const panelImage = document.getElementById("panel-image");

        const descriptionInput = document.getElementById("expense-description");
        const classifyTextButton = document.getElementById("classify-text-button");

        const invoiceUpload = document.getElementById("invoice-upload");
        const imagePreview = document.getElementById("image-preview");
        const pdfPreview = document.getElementById("pdf-preview");
        const pdfFilename = document.getElementById("pdf-filename");
        const placeholderText = document.getElementById("placeholder-text");
        const classifyImageButton = document.getElementById("classify-image-button");
        
        const errorMessage = document.getElementById("error-message");
        const resultsPanel = document.getElementById("results-panel");
        const tableBody = document.getElementById("table-body");
        const downloadExcelButton = document.getElementById("download-excel-button");

        // --- Utilidades ---
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        function formatCurrencyUY(amount) {
            if (amount === null || amount === undefined || amount === "" || isNaN(amount)) return "0,00";
            return new Intl.NumberFormat('es-UY', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // --- Helpers UI ---
        function setButtonLoading(btn, isLoading, originalText) {
            const contentSpan = btn.querySelector('.btn-text');
            const loadingSpan = btn.querySelector('.btn-loader');
            
            if (isLoading) {
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-not-allowed', 'bg-indigo-500');
                btn.classList.remove('hover:bg-indigo-700');
                if(contentSpan) contentSpan.classList.add('hidden');
                if(loadingSpan) loadingSpan.classList.remove('hidden');
            } else {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed', 'bg-indigo-500');
                btn.classList.add('hover:bg-indigo-700');
                if(contentSpan) contentSpan.classList.remove('hidden');
                if(loadingSpan) loadingSpan.classList.add('hidden');
            }
        }

        // --- Carga de Rubros desde JSON ---
        async function fetchRubros() {
             try {
                const response = await fetch('./listado_odg_completo.json');
                if (!response.ok) {
                   throw new Error(`HTTP error! Status: ${response.status}`);
                }
                RUBROS_DB = await response.json();
                console.log("Rubros loaded:", RUBROS_DB.length);
             } catch(error) {
                 console.error("Failed to load rubros:", error);
                 errorMessage.textContent = "Error: No se pudo cargar la base de datos de rubros. Verifica que 'listado_odg_completo.json' est茅 en la misma carpeta.";
                 errorMessage.classList.remove("hidden");
                 classifyTextButton.disabled = true;
                 classifyImageButton.disabled = true;
             }
        }

        // --- Firebase Logic ---
        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser.uid;

                // CAMBIO CLAVE: Usar ruta PBLICA para reglas compartidas
                // artifacts/{appId}/public/data/app_config/global_criteria
                criteriaDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_config', 'global_criteria');
                listenForCriteria();

            } catch (error) {
                console.error("Error Firebase:", error);
            }
        }

        function listenForCriteria() {
            if (!criteriaDocRef) return;
            onSnapshot(criteriaDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentSavedCriteria = docSnap.data().criteria || "";
                    criteriaInput.value = currentSavedCriteria;
                } else {
                    currentSavedCriteria = "";
                    criteriaInput.value = "";
                }
            });
        }

        async function saveCriteria() {
            if (!criteriaDocRef) return;
            saveSettingsButton.textContent = "Guardando...";
            try {
                await setDoc(criteriaDocRef, { criteria: criteriaInput.value });
                saveSettingsButton.textContent = "隆Guardado!";
                setTimeout(() => saveSettingsButton.textContent = "Guardar Cambios Globales", 2000);
            } catch (e) {
                console.error(e);
                saveSettingsButton.textContent = "Error al guardar";
            }
        }

        // --- L贸gica de Interfaz ---
        
        settingsBtn.addEventListener("click", () => {
            criteriaPanel.classList.toggle("hidden");
        });

        function switchTab(mode) {
            resultsPanel.classList.add("hidden");
            errorMessage.classList.add("hidden");
            
            if (mode === 'text') {
                panelText.classList.remove("hidden");
                panelImage.classList.add("hidden");
                tabText.className = "flex-1 py-4 text-center transition-colors duration-200 tab-active focus:outline-none";
                tabImage.className = "flex-1 py-4 text-center transition-colors duration-200 tab-inactive focus:outline-none";
            } else {
                panelText.classList.add("hidden");
                panelImage.classList.remove("hidden");
                tabImage.className = "flex-1 py-4 text-center transition-colors duration-200 tab-active focus:outline-none";
                tabText.className = "flex-1 py-4 text-center transition-colors duration-200 tab-inactive focus:outline-none";
            }
        }

        tabText.addEventListener("click", () => switchTab('text'));
        tabImage.addEventListener("click", () => switchTab('image'));

        invoiceUpload.addEventListener("change", (event) => {
            const file = event.target.files[0];
            classifyImageButton.disabled = !file;
            classifyImageButton.classList.toggle("opacity-50", !file);
            classifyImageButton.classList.toggle("cursor-not-allowed", !file);
            
            currentImageFile = file || null;
            
            imagePreview.classList.add("hidden");
            pdfPreview.classList.add("hidden");
            placeholderText.classList.remove("hidden");

            if (file) {
                placeholderText.classList.add("hidden");
                if (file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove("hidden");
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === "application/pdf") {
                    pdfFilename.textContent = file.name;
                    pdfPreview.classList.remove("hidden");
                } 
            }
        });

        // --- L贸gica de Clasificaci贸n (API Gemini) ---

        async function callGeminiAPI(prompt, inlineData = null) {
            if (!apiKey) {
                throw new Error("Falta la API Key en el c贸digo. Por favor, configura la variable 'apiKey' en el archivo HTML.");
            }

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        ...(inlineData ? [{ inlineData: inlineData }] : [])
                    ]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "Concepto": { "type": "STRING" },
                                "Numero_ODG": { "type": "STRING" },
                                "Nombre_Rubro": { "type": "STRING" },
                                "Importe": { "type": "NUMBER" },
                                "Moneda": { "type": "STRING" },
                                "Motivo": { "type": "STRING" }
                            }
                        }
                    }
                }
            };

            let response;
            for(let i=0; i<3; i++) {
                try {
                    response = await fetch(`${API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if(response.ok) break;
                } catch(e) { console.error(e); }
                await new Promise(r => setTimeout(r, 1000 * (i+1)));
            }

            if (!response || !response.ok) {
                const errText = response ? await response.text() : "Error de red";
                const status = response ? response.status : 0;
                throw new Error(`Error al conectar con la IA: ${status} - ${errText}`);
            }

            const result = await response.json();
            const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (jsonText) {
                return JSON.parse(jsonText);
            } else {
                throw new Error("La IA no devolvi贸 resultados legibles.");
            }
        }

        // 1. Clasificaci贸n de TEXTO
        classifyTextButton.addEventListener("click", async () => {
            const text = descriptionInput.value.trim();
            if (!text) return;

            setButtonLoading(classifyTextButton, true);
            resultsPanel.classList.add("hidden");
            errorMessage.classList.add("hidden");

            try {
                const prompt = `
                Act煤a como un contador experto en finanzas p煤blicas de Uruguay. Analiza la siguiente descripci贸n de un gasto.
                Tu tarea es identificar el concepto, extraer el importe si existe (sino pon 0), identificar la moneda (sino asume UYU) y clasificarlo en un Rubro (ODG).

                Descripci贸n: "${text}"

                INSTRUCCIONES FORMATO:
                1. 'Importe': NMERO PURO (JSON Number), ej: 1250.50.
                2. 'Concepto': Resumen breve.
                3. 'Numero_ODG': El numero del rubro (ej: 111-000). Usa exactamente el ID de la lista provista.
                4. 'Nombre_Rubro': El nombre del rubro (ej: Alimentaci贸n). Usa exactamente el nombre de la lista provista.
                5. 'Motivo': Breve explicaci贸n de por qu茅 se eligi贸 ese rubro.
                
                Base de Datos Rubros (TOTAL ${RUBROS_DB.length}): ${JSON.stringify(RUBROS_DB)}
                Criterios Globales de Equipo: ${currentSavedCriteria || "Ninguno"}
                
                Responde SOLO con un Array JSON con 1 objeto.
                `;

                classifiedData = await callGeminiAPI(prompt);
                renderResultsToTable(classifiedData);
                resultsPanel.classList.remove("hidden");

            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.classList.remove("hidden");
            } finally {
                setButtonLoading(classifyTextButton, false);
            }
        });

        // 2. Clasificaci贸n de DOCUMENTO (Imagen/PDF)
        classifyImageButton.addEventListener("click", async () => {
            if (!currentImageFile) return;

            setButtonLoading(classifyImageButton, true);
            resultsPanel.classList.add("hidden");
            errorMessage.classList.add("hidden");

            try {
                const base64Data = await fileToBase64(currentImageFile);
                const inlineData = { mimeType: currentImageFile.type, data: base64Data };

                const prompt = `
                Act煤a como contador experto de Uruguay. Analiza la factura adjunta. Extrae CADA l铆nea de gasto individual.
                
                INSTRUCCIONES:
                1. 'Importe': NMERO PURO (JSON Number). Ejemplo: 1200.50 (usa punto decimal, NO separador de miles).
                2. 'Numero_ODG': El numero del rubro (ej: 111-000). Usa exactamente el ID de la lista provista que mejor se ajuste.
                3. 'Nombre_Rubro': El nombre del rubro (ej: Alimentaci贸n). Usa exactamente el nombre de la lista provista.
                4. 'Motivo': Breve explicaci贸n de por qu茅 se eligi贸 ese rubro.
                
                Base de Datos Rubros (TOTAL ${RUBROS_DB.length}): ${JSON.stringify(RUBROS_DB)}
                Criterios Globales de Equipo: ${currentSavedCriteria || "Ninguno"}
                
                Responde SOLO con un Array JSON con todos los items encontrados.
                `;

                classifiedData = await callGeminiAPI(prompt, inlineData);
                renderResultsToTable(classifiedData);
                resultsPanel.classList.remove("hidden");

            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.classList.remove("hidden");
            } finally {
                setButtonLoading(classifyImageButton, false);
            }
        });

        // Renderizar Tabla
        function renderResultsToTable(data) {
            tableBody.innerHTML = '';
            if (!data || data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No se encontraron items.</td></tr>';
                return;
            }

            data.forEach((item) => {
                const row = tableBody.insertRow();
                const importeVisual = formatCurrencyUY(item.Importe);
                
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.Concepto}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 text-right font-mono">${importeVisual}</td>
                    <td class="px-2 py-4 whitespace-nowrap text-sm text-gray-500 text-center">${item.Moneda || 'UYU'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-indigo-600 font-semibold">${item.Numero_ODG || 'N/A'}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700">${item.Nombre_Rubro || 'Otros'}</td>
                    <td class="px-4 py-4 text-sm text-gray-500 italic text-wrap max-w-xs">${item.Motivo || ''}</td>
                `;
            });
        }

        // Generar Excel
        downloadExcelButton.addEventListener("click", async () => {
            if (classifiedData.length === 0) return;

            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet('Gastos');

            worksheet.columns = [
                { header: 'Concepto', key: 'Concepto', width: 30 },
                { header: 'Importe', key: 'Importe', width: 15, style: { numFmt: '#,##0.00' } }, 
                { header: 'Moneda', key: 'Moneda', width: 10 },
                { header: 'ODG', key: 'Numero_ODG', width: 15 },
                { header: 'Descripci贸n Rubro', key: 'Nombre_Rubro', width: 30 },
                { header: 'Motivo', key: 'Motivo', width: 40 }
            ];

            // Estilo encabezado
            worksheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
            worksheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF4F46E5' } };

            classifiedData.forEach(item => {
                worksheet.addRow({
                    Concepto: item.Concepto,
                    Importe: item.Importe,
                    Moneda: item.Moneda || 'UYU',
                    Numero_ODG: item.Numero_ODG,
                    Nombre_Rubro: item.Nombre_Rubro,
                    Motivo: item.Motivo
                });
            });

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gastos_${new Date().toISOString().split('T')[0]}.xlsx`;
            a.click();
        });

        // Init
        await Promise.all([initFirebase(), fetchRubros()]);
        saveSettingsButton.addEventListener("click", saveCriteria);

    </script>
</body>
</html>
